#include "gamevars.h"
#include <c64/vic.h>

//byte* const Screen     = (byte*)0xc800;
//byte* const Screen     = (byte*)0x0400;
//byte* const Color      = (byte*)0xd800;
//byte* const Sprite     = (byte*)0x0380;
//byte* const Sprite     = (byte*)0xd800;
//byte* const Charset    = (byte *)0xd000;


byte* const Screen     = (byte*)0xc800;
byte* const Color      = (byte*)0xd800; // Keep this, it's hardwired
byte* const Sprite     = (byte*)0xc000; // Move sprites to the start of the bank
byte* const Charset    = (byte*)0xd000;

const struct tile		tiles[7] =
{
	{ 0, 
    { 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 }, 
    { 0, 4, 7, 10 }, //  ####
    { 4, 1, 4, 1 },    
    { 1, 4, 1, 4 }, 
    VCOL_CYAN, 
    {0, 1, 2, 3}, 
    {0, 0, 0, 0}
  },
	{ 1, 
    { 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 },
    { 0, 4, 7, 10 },   //  ##
    { 2, 2, 2, 2 },    //  ## 
    { 2, 2, 2, 2 },    
    VCOL_YELLOW,
    {0, 1, 0, 1},
    {0, 0, 1, 1}
  },
  { 2,
    { 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0 },
    { 0, 6, 12, 18 },    //  #    #   ###    #
    { 3, 2, 3, 2 },      // ###   ##   #    ##
    { 2, 3, 2, 3 },      //       #          #
    VCOL_PURPLE,
    {1, 0, 1, 2},
    {0, 1, 1, 1}
  },
  { 3,
    { 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1 },
    { 0, 6, 12, 18 },     //  ##   #     ##   #
    { 3, 2, 3, 2 },       // ##    ##   ##    ##
    { 2, 3, 2, 3 },       //        #          #
    VCOL_GREEN,
    {1, 2, 0, 1},
    {0, 0, 1, 1}
  },
  { 4,
    { 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0 },
    { 0, 6, 12, 18 },     // ##
    { 3, 2, 3, 2 },       //  ##
    { 2, 3, 2, 3 },
    VCOL_RED,
    {0, 1, 1, 2},
    {0, 0, 1, 1}
  },
  { 5,
    { 1, 0, 0, 1, 1, 1, 
      1, 1, 1, 0, 1, 0, 
      1, 1, 1, 0, 0, 1,
      0, 1, 0, 1, 1, 1 },
    { 0, 6, 12, 18 },    // #    ##  ###    #
    { 3, 2, 3, 2 },      // ###  #     #    #
    { 2, 3, 2, 3 },      //      #         ##
    VCOL_BLUE, 
    {0, 0, 1, 2}, 
    {0, 1, 1, 1}
  },
	{ 6,
    { 0, 0, 1, 1, 1, 1, 
      1, 0, 1, 0, 1, 1,
      1, 1, 1, 1, 0, 0,
      1, 1, 0, 1, 0, 1 },
    { 0, 6, 12, 18 },   //   #  #    ###  ##
    { 3, 2, 3, 2 },     // ###  #    #     #
    { 2, 3, 2, 3 },     //      ##         #
    VCOL_ORANGE,
    {3, 0, 1, 2},
    {0, 1, 1, 1}
  },
	
};

//                         01234567890123456789012345678901234567890
const char StatusText[] = s" Score: 000000  Lines: 000000  Level: 00";
//const char StatusText[] = " SCORE: 000000  LINES: 000000   LEVEL: 0 ";
/*
const char StatusText[40] = {32, 19,  3, 15, 18,  5, 58, 32, 48, 48, 48, 48, 48, 48,
  32, 32, 12,  9, 14,  5, 19, 58, 32, 48, 48, 48, 48, 48, 48,
  32, 32, 12,  5, 22,  5, 12, 58, 32, 48, 49 };
*/

const unsigned char level_y_inc[10] = {4, 6, 9, 12, 15, 18, 21, 24, 27, 30};

struct Game TheGame = {0};

char active_flicker_count = 0;

const Vector2 KICK_DATA_GENERIC[8][5] = {
  {{0, 0}, {-1, 0}, {-1, 1}, {0,-2}, {-1,-2}}, // 0 -> 1
  {{0, 0}, { 1, 0}, { 1,-1}, {0, 2}, { 1, 2}}, // 1 -> 0
  {{0, 0}, { 1, 0}, { 1,-1}, {0, 2}, { 1, 2}}, // 1 -> 2
  {{0, 0}, {-1, 0}, {-1, 1}, {0,-2}, {-1,-2}}, // 2 -> 1
  {{0, 0}, { 1, 0}, { 1, 1}, {0,-2}, { 1,-2}}, // 2 -> 3
  {{0, 0}, {-1, 0}, {-1,-1}, {0, 2}, {-1, 2}}, // 3 -> 2
  {{0, 0}, {-1, 0}, {-1,-1}, {0, 2}, {-1, 2}}, // 3 -> 0
  {{0, 0}, { 1, 0}, { 1, 1}, {0,-2}, { 1,-2}}  // 0 -> 3
};

// Tests for I piece
const Vector2 KICK_DATA_I[8][5] = {
  {{0, 0}, {-2, 0}, { 1, 0}, {-2,-1}, { 1, 2}}, // 0 -> 1
  {{0, 0}, { 2, 0}, {-1, 0}, { 2, 1}, {-1,-2}}, // 1 -> 0
  {{0, 0}, {-1, 0}, { 2, 0}, {-1, 2}, { 2,-1}}, // 1 -> 2
  {{0, 0}, { 1, 0}, {-2, 0}, { 1,-2}, {-2, 1}}, // 2 -> 1
  {{0, 0}, { 2, 0}, {-1, 0}, { 2, 1}, {-1,-2}}, // 2 -> 3
  {{0, 0}, {-2, 0}, { 1, 0}, {-2,-1}, { 1, 2}}, // 3 -> 2
  {{0, 0}, { 1, 0}, {-2, 0}, { 1,-2}, {-2, 1}}, // 3 -> 0
  {{0, 0}, {-1, 0}, { 2, 0}, {-1, 2}, { 2,-1}}  // 0 -> 3
};

const byte SpriteImage[64] = {
	0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b01010101, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000,
  0b00000000, 0b00000000, 0b00000000
};

const byte SpriteImageC[64] = {
  255,0,0,253,0,0,233,0,0,233,0,0,233,0,0,233,
  0,0,213,0,0,85,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,135
};

const char MicroFont[] = {
      0, 60,204,204,192,204, 48,  0,
  0, 48,204,252,204,204,204,  0,
  0,240,204,240,204,204,240,  0,
  0, 60,192,192,192,192, 60,  0,
  0,240,204,204,204,204,240,  0,
  0,252,192,240,192,192,252,  0,
  0,252,192,240,192,192,192,  0,
  0,252,192,192,204,204, 48,  0,
  0,204,204,252,204,204,204,  0,
  0, 48, 48, 48, 48, 48, 48,  0,
  0, 12, 12, 12, 12,204, 48,  0,
  0,204,204,240,240,204,204,  0,
  0,192,192,192,192,192,252,  0,
  0,204,252,204,204,204,204,  0,
  0,204,204,252,252,204,204,  0,
  0,252,204,204,204,204,252,  0,
  0,252,204,252,192,192,192,  0,
  0,252,204,204,204,252, 12,  0,
  0,240,204,240,204,204,204,  0,
  0, 60,192,240, 12, 12,240,  0,
  0,252, 48, 48, 48, 48, 48,  0,
  0,204,204,204,204,204,252,  0,
  0,204,204,204,204,204, 48,  0,
  0,204,204,204,204,252,204,  0,
  0,204,204, 48, 48,204,204,  0,
  0,204,204,252, 48, 48, 48,  0,
  0,252, 12, 60,192,240,252,  0,
 60, 48, 48, 48, 48, 48, 60,  0,
  0, 48,204,192, 48,192,252,  0,
  0, 60, 12, 12, 12, 12, 60,  0,
  0, 48,252,252, 48, 48, 48, 48,
  0,  0, 48,255,255, 48,  0,  0,
  0,  0,  0,  0,  0,  0,  0,  0,
  0, 48, 48, 48, 48,  0, 48,  0,
  0,204,204,204,  0,  0,  0,  0,
  0, 51,255, 51, 51,255, 51,  0,
  0, 60,240, 48, 60, 60,240,  0,
  0,204, 12, 48, 48,192,204,  0,
  0, 48,204, 48, 48,204, 60,  0,
  0, 12, 48,  0,  0,  0,  0,  0,
  0, 12, 48, 48, 48, 48, 12,  0,
  0, 48, 12, 12, 12, 12, 48,  0,
  0,204, 48,252, 48,204,  0,  0,
  0, 48, 48,252, 48, 48,  0,  0,
  0,  0,  0,  0,  0, 48, 48,  0,
  0,  0,  0,252,  0,  0,  0,  0,
  0,  0,  0,  0,  0, 48, 48,  0,
  0,  0, 12,  0, 48,  0,192,  0,
  0,252,204,204,204,204,252,  0,
  0, 48,240, 48, 48, 48,252,  0,
  0, 48,204, 12, 48,192,252,  0,
  0,252, 12, 48, 12,252,  0,  0,
  0, 12, 48,204,252, 12, 12,  0,
  0,252,192, 48, 12,204,252,  0,
  0,252,192,192,252,204, 48,  0,
  0,252, 12, 48, 48, 48, 48,  0,
  0,252,204,252,204,204,252,  0,
  0, 48,204, 60, 12,204, 48,  0,
  0,  0, 48,  0,  0, 48,  0,  0,
  0,  0, 48,  0,  0, 48,240,  0,
  0, 60, 48,192,192, 48, 12,  0,
  0,  0, 60,  0, 60,  0,  0,  0,
  0,240, 48, 12, 12, 48,192,  0,
  0,252, 12, 12, 48,  0, 48,  0,
  0,  0,  0,255,  0,  0,  0,  0,
  0, 48,252,252,252, 48,204,  0,
 48, 48, 48, 48, 48, 48, 48, 48,
  0,  0,  0,  0,  0,255,  0,  0,
  0,  0,  0,  0,255,  0,  0,  0,
  0,  0,  0,255,  0,  0,  0,  0,
  0,  0,  0,  0,  0,  0,255,  0,
 48, 48, 48, 48, 48, 48, 48, 48,
 12, 12, 12, 12, 12, 12, 12, 12,
  0,  0,192, 48, 48, 12, 12, 12,
192,192,192, 48, 48, 63,  0,  0,
 12, 12, 12, 48, 48,192,  0,  0,
192,192,192,192,192,192,255,  0,
192,192,240, 48, 60, 12, 15,  3,
  3, 15, 12, 60, 48,240,192,192,
  0,255,192,192,192,192,192,192,
  0,252, 12, 12, 12, 12, 12, 12,
  0, 48,252,252,252,252, 48,  0,
  0,  0,  0,  0,  0,  0,255,  0,
  0,204,252,252,252,252, 48,  0,
192,192,192,192,192,192,192,192,
  0,  0,  3, 12, 48, 48, 48, 48,
195,195, 60, 60, 60, 60,195,195,
  0, 48,252,204,204,252, 48,  0,
  0, 48,204,204, 48, 48,252,  0,
 12, 12, 12, 12, 12, 12, 12, 12,
  0, 48, 60,252,252,240, 48,  0,
 60, 60, 60,255,255, 60, 60, 60,
 48,192, 48,192, 48,192, 48,192,
 48, 48, 48, 48, 48, 48, 48, 48,
  0,  0,  3, 60,204, 51, 51,  0,
255,255, 63, 63, 15, 15,  3,  3,
  0,  0,  0,  0,  0,  0,  0,  0,
240,240,240,240,240,240,240,240,
  0,  0,  0,  0,  0,255,255,  0,
  0,255,  0,  0,  0,  0,  0,  0,
  0,  0,  0,  0,  0,  0,255,  0,
192,192,192,192,192,192,192,192,
204,204, 51, 51,204,204, 51, 51,
  3,  3,  3,  3,  3,  3,  3,  3,
  0,  0,  0,  0,204,204, 51, 51,
255,252,252,240,240,192,192,192,
 12, 12, 12, 12, 12, 12, 12, 12,
 48, 48, 48, 63, 63, 48, 48, 48,
  0,  0,  0,  0, 60, 60, 60,  0,
 48, 48, 48, 63,  0,  0,  0,  0,
  0,  0,  0,240, 48, 48, 48, 48,
  0,  0,  0,  0,  0,  0,255,  0,
  0,  0,  0, 63, 48, 48, 48, 48,
 48, 48, 48,255,  0,  0,  0,  0,
  0,  0,  0,255, 48, 48, 48, 48,
 48, 48, 48,240, 48, 48, 48, 48,
192,192,192,192,192,192,192,192,
240,240,240,240,240,240,240,240,
 15, 15, 15, 15, 15, 15, 15, 15,
255,  0,  0,  0,  0,  0,  0,  0,
255,255,  0,  0,  0,  0,  0,  0,
  0,  0,  0,  0,  0,  0,255,255,
  3,  3,  3,  3,  3,  3,  3,255,
  0,  0,  0,  0,240,240,240,240,
 15, 15, 15, 15,  0,  0,  0,  0,
 48, 48, 48,240,  0,  0,  0,  0,
240,240,240,240,  0,  0,  0,  0,
240,240,240,240, 15, 15, 15, 15,
255,195, 51, 51, 63, 51,207,255,
  0, 60,255,255,255,255, 60,  0,
  0, 60,195,195,195,195, 60,  0,
  0,  0, 60, 60, 60,  0,  0,  0,
255,195,195,195,195,195,195,255,
102,129, 66,129, 66,129, 66,153,
119,221,119,221,119,221,119,221,
153,153,153,153,153,153,153,153,
255, 51, 51,  3, 51, 51, 51,255,
255,207,207,207,207,207,207,255,
255,243,243,243,243, 51,207,255,
255, 51, 51, 15, 15, 51, 51,255,
255, 63, 63, 63, 63, 63,  3,255,
255, 51,  3, 51, 51, 51, 51,255,
255, 51, 51,  3,  3, 51, 51,255,
255,  3, 51, 51, 51, 51,  3,255,
255,  3, 51,  3, 63, 63, 63,255,
255,  3, 51, 51, 51,  3,243,255,
255, 15, 51, 15, 51, 51, 51,255,
255,195, 63, 15,243,243, 15,255,
255,  3,207,207,207,207,207,255,
255, 51, 51, 51, 51, 51,  3,255,
255, 51, 51, 51, 51, 51,207,255,
255, 51, 51, 51, 51,  3, 51,255,
255, 51, 51,207,207, 51, 51,255,
255, 51, 51,  3,207,207,207,255,
255,  3,243,195, 63, 15,  3,255,
195,207,207,207,207,207,195,255,
255,207, 51, 63,207, 63,  3,255,
195,243,243,243,243,243,195,255,
255,207,  3,  3,207,207,207,207,
255,255,207,  0,  0,207,255,255,
255,255,255,255,255,255,255,255,
255,207,207,207,207,255,207,255,
255, 51, 51, 51,255,255,255,255,
255,204,  0,204,204,  0,204,255,
255,195, 15,207,195,195, 15,255,
255, 51,243,207,207, 63, 51,255,
255,207, 51,207,207, 51,195,255,
255,243,207,255,255,255,255,255,
255,243,207,207,207,207,243,255,
255,207,243,243,243,243,207,255,
255, 51,207,  3,207, 51,255,255,
255,207,207,  3,207,207,255,255,
255,255,255,255,255,207,207,255,
255,255,255,  3,255,255,255,255,
255,255,255,255,255,207,207,255,
255,255,243,255,207,255, 63,255,
255,  3, 51, 51, 51,  3,255,255,
255,207, 15,207,207,207,  3,255,
255,207, 51,243,207, 63,  3,255,
255,  3,243,207,243,  3,255,255,
255,243,207, 51,  3,243,243,255,
255,  3, 63,207,243, 51,  3,255,
255,  3, 63, 63,  3, 51,207,255,
255,  3,243,207,207,207,207,255,
255,  3, 51,  3, 51, 51,  3,255,
255,207, 51,195,243, 51,207,255,
255,255,207,255,255,207,255,255,
255,255,207,255,255,207, 15,255,
255,195,207, 63, 63,207,243,255,
255,255,195,255,195,255,255,255,
255, 15,207,243,243,207, 63,255,
255,  3,243,243,207,255,207,255,
255,255,255,  0,255,255,255,255,
255,207,  3,  3,  3,207, 51,255,
207,207,207,207,207,207,207,207,
255,255,255,255,255,  0,255,255,
255,255,255,255,  0,255,255,255,
255,255,255,  0,255,255,255,255,
255,255,255,255,255,255,  0,255,
207,207,207,207,207,207,207,207,
243,243,243,243,243,243,243,243,
255,255, 63,207,207,243,243,243,
 63, 63, 63,207,207,192,255,255,
243,243,243,207,207, 63,255,255,
 63, 63, 63, 63, 63, 63,  0,255,
 63, 63, 15,207,195,243,240,252,
252,240,243,195,207, 15, 63, 63,
255,  0, 63, 63, 63, 63, 63, 63,
255,  3,243,243,243,243,243,243,
255,207,  3,  3,  3,  3,207,255,
255,255,255,255,255,255,  0,255,
255, 51,  3,  3,  3,  3,207,255,
 63, 63, 63, 63, 63, 63, 63, 63,
255,255,252,243,207,207,207,207,
 60, 60,195,195,195,195, 60, 60,
255,207,  3, 51, 51,  3,207,255,
255,207, 51, 51,207,207,  3,255,
243,243,243,243,243,243,243,243,
255,207,195,  3,  3, 15,207,255,
195,195,195,  0,  0,195,195,195,
207, 63,207, 63,207, 63,207, 63,
207,207,207,207,207,207,207,207,
255,255,252,195, 51,204,204,255,
  0,  0,192,192,240,240,252,252,
255,255,255,255,255,255,255,255,
 15, 15, 15, 15, 15, 15, 15, 15,
255,255,255,255,  0,  0,  0,  0,
  0,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,  0,
 63, 63, 63, 63, 63, 63, 63, 63,
 51, 51,204,204, 51, 51,204,204,
252,252,252,252,252,252,252,252,
255,255,255,255, 51, 51,204,204,
  0,  3,  3, 15, 15, 63, 63, 63,
243,243,243,243,243,243,243,243,
207,207,207,192,192,207,207,207,
255,255,255,255,240,240,240,240,
207,207,207,207,192,255,255,255,
255,255,255, 15,207,207,207,207,
255,255,255,255,255,255,  0,255,
255,255,255,192,207,207,207,255,
195,195,195,  0,  0,255,255,255,
255,255,255,  0,  0,195,195,195,
195,195,195,  3,  3,195,195,195,
 63, 63, 63, 63, 63, 63, 63, 63,
 15, 15, 15, 15, 15, 15, 15, 15,
240,240,240,240,240,240,240,240,
  0,255,255,255,255,255,255,255,
  0,  0,255,255,255,255,255,255,
255,255,255,255,255,255,  0,  0,
252,252,252,252,252,252,252,  0,
255,255,255,255, 15, 15, 15, 15,
240,240,240,240,255,255,255,255,
243,243,243,243,  3,  3,255,255,
 15, 15, 15, 15,255,255,255,255,
 15, 15, 15, 15,240,240,240,240


};

// Scroll character layout in charset (indices 220-235):
//   220       : solid block (all 8 rows = 0xFF)
//   221-227   : top-heavy, offset N=1..7 (top N rows 0xFF, rest 0x00)
//   228-234   : bottom-heavy, offset N=1..7 (top N rows 0x00, rest 0xFF)
//   235       : empty block (all 8 rows = 0x00)
// Must be called while MMAP_CHAR_ROM is active (caller's responsibility).
void generate_scroll_chars(void) {
  char i, n;

  // char 220: solid
  for(i = 0; i < 8; i++) Charset[220 * 8 + i] = 0xFF;

  // chars 221-227: top-heavy for offsets 1-7
  for(n = 1; n <= 7; n++) {
    for(i = 0; i < 8; i++)
      Charset[(220 + n) * 8 + i] = (i < n) ? 0xFF : 0x00;
  }

  // chars 228-234: bottom-heavy for offsets 1-7
  for(n = 1; n <= 7; n++) {
    for(i = 0; i < 8; i++)
      Charset[(227 + n) * 8 + i] = (i < n) ? 0x00 : 0xFF;
  }

  // char 235: empty
  for(i = 0; i < 8; i++) Charset[235 * 8 + i] = 0x00;
}